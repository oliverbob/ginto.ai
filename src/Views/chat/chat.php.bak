<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="/assets/images/ginto.png" />
  <title><?= htmlspecialchars($title ?? 'Ginto /chat') ?></title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#111;margin:20px}
    .chat-wrap{max-width:900px}
    #messages{background:#f7f7f7;padding:12px;border-radius:8px;min-height:200px;max-height:60vh;overflow:auto;position:relative}
    #messages .bg-hint{position:absolute;inset:12px;display:flex;align-items:center;justify-content:center;color:#9aa0a6;font-size:18px;pointer-events:none}
    .msg{Padding:10px 12px;margin:8px 0;border-radius:8px;max-width:78%}
    .msg.user{background:#e6f0ff;margin-left:auto;text-align:left}
    .msg.assistant{background:#fff;margin-right:auto;border:1px solid #eee}
    .meta{font-size:12px;color:#666;margin-bottom:6px}
    #composer{margin-top:10px}
    textarea{width:100%;height:120px}
    button{padding:8px 14px}
    .toolbar{margin-top:8px;display:flex;gap:8px}
    /* Code block with copy button */
    .code-block-wrapper{position:relative;margin:8px 0}
    .code-block-wrapper pre{background:#1e1e1e;color:#d4d4d4;padding:12px;border-radius:6px;overflow-x:auto;margin:0;font-family:'Fira Code',Consolas,Monaco,monospace;font-size:13px;line-height:1.5}
    .copy-code-btn{position:absolute;top:8px;right:8px;background:#333;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer;opacity:0.8;transition:opacity 0.2s}
    .copy-code-btn:hover{opacity:1;background:#555}
    .tree-output{white-space:pre;font-family:'Fira Code',Consolas,Monaco,monospace}
  </style>
</head>
<body>
  <h1>/chat — Groq streaming test</h1>
  <div style="margin-bottom:8px">
    <strong>MCP:</strong> <span id="mcp-badge" style="color:#666">unknown</span>
  </div>
  <div id="mcp-capabilities" style="margin-bottom:8px;color:#333;font-size:13px">&nbsp;</div>

  <div class="chat-wrap">
    <div id="messages" aria-live="polite">
      <div class="bg-hint">Describe what to build — e.g. "Add validation for editorFile, return JSON tasks"</div>
    </div>

    <div id="composer">
      <label for="prompt">Prompt</label>
      <textarea id="prompt" placeholder="Describe what to build (press Enter to send, Shift+Enter for newline)"></textarea>
      <div class="toolbar">
        <button id="send">Send</button>
        <button id="clear">Clear</button>
        <button id="describe_repo">Describe Repo</button>
        <button id="reset_history">Reset History</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:12px;align-items:center">
        <label style="font-size:14px"><input type="checkbox" id="enable_audio"> Enable audio (TTS)</label>
        <button id="stop_audio" type="button">Stop Audio</button>
        <small style="color:#666">Assistant replies will be spoken when <code>Enable audio</code> is checked.</small>
        <div id="tts_state" style="margin-left:12px;color:#066;font-size:13px">(idle)</div>
      </div>
      <div style="margin-top:8px;display:flex;gap:12px;align-items:center">
        <button id="start_stt" type="button">Start Listening (STT)</button>
        <button id="stop_stt" type="button" disabled>Stop Listening</button>
        <small style="color:#666">Click Start, speak, then Stop to send speech for server-side STT.</small>
      </div>
      <div style="margin-top:8px;display:flex;gap:12px;align-items:center">
        <button id="train_wake" type="button">Train Wake Word</button>
        <label style="font-size:14px"><input type="checkbox" id="enable_wake"> Enable wake-word</label>
        <div id="wake_status" style="color:#666;font-size:13px">(wake not trained)</div>
        <small style="color:#666">Train a short phrase (~1s) and enable monitoring to auto-start STT.</small>
      </div>
      <div style="margin-top:8px">
        <div style="font-weight:600;margin-bottom:6px;color:#222">Live transcript:</div>
        <div id="stt_transcript" role="status" aria-live="polite" style="background:#fff;border:1px solid #eee;padding:8px;border-radius:6px;min-height:40px;max-height:120px;overflow:auto;color:#222">(not listening)</div>
        <div id="stt_debug" style="font-size:12px;color:#666;margin-top:8px;min-height:22px;">&nbsp;</div>
        <!-- File-upload for STT removed: server-side STT uses recorder stop -->
      </div>
    </div>
  </div>
  <input type="hidden" id="csrf_token" value="<?= htmlspecialchars($csrf_token ?? '') ?>">
  <script>window.CSRF_TOKEN = <?= json_encode($csrf_token ?? '') ?>;</script>
  <!-- STT model exposure removed from client to avoid leaking provider details -->
  <div style="margin-top:8px">
    <button id="send">Send</button>
    <button id="clear">Clear</button>
  </div>

  <h2>Output</h2>
  <pre id="output">(no output yet)</pre>

  <script src="/assets/js/chat.js"></script>
</body>
</html>
