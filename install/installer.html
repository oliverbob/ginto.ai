<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ginto CMS Installation</title>

    <link href="/assets/css/tailwind.css" rel="stylesheet">
    <script>
        // Prefill helper and password toggle, kept in head so buttons are available early
        function setIfEmpty(name, val) {
            if (typeof val === 'undefined' || val === null) return;
            const el = document.querySelector(`[name="${name}"]`);
            if (!el) return;
            if (!el.value) el.value = val;
        }

        const EYE_SVG = '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
        const EYE_OFF_SVG = '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.38 21.38 0 0 1 5.6-7.03"></path><path d="M1 1l22 22"></path><path d="M9.88 9.88A3 3 0 0 0 14.12 14.12"></path></svg>';

        window.togglePassword = function(fieldName, btn) {
            const el = document.querySelector(`[name="${fieldName}"]`);
            if (!el) return;
            const wasHidden = el.type === 'password';
            el.type = wasHidden ? 'text' : 'password';
            btn.setAttribute('aria-pressed', wasHidden ? 'true' : 'false');
            try { btn.innerHTML = wasHidden ? EYE_OFF_SVG : EYE_SVG; } catch (e) {}
        };

        // Try to prefill values from existing .env if available
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                const resp = await fetch('/install.php?action=get_env_values');
                if (!resp.ok) return;
                const data = await resp.json();
                if (!data.success) return;
                const values = data.values || {};

                // Site
                setIfEmpty('site_name', values.APP_NAME || values.APP_NAME);
                setIfEmpty('site_description', values.APP_DESCRIPTION || values.APP_DESCRIPTION);
                setIfEmpty('site_url', values.APP_URL || window.location.origin);

                // Admin account
                setIfEmpty('admin_email', values.ADMIN_EMAIL ?? values.ADMIN_EMAIL);
                setIfEmpty('admin_username', values.ADMIN_USERNAME ?? values.ADMIN_USERNAME);
                setIfEmpty('admin_first_name', values.ADMIN_FIRST_NAME ?? values.ADMIN_FIRST_NAME);
                setIfEmpty('admin_middle_name', values.ADMIN_MIDDLE_NAME ?? values.ADMIN_MIDDLE_NAME);
                setIfEmpty('admin_last_name', values.ADMIN_LAST_NAME ?? values.ADMIN_LAST_NAME);
                setIfEmpty('admin_password', values.ADMIN_PASSWORD ?? '');

                // Default user account
                setIfEmpty('default_username', values.DEFAULT_USERNAME ?? values.DEFAULT_USERNAME);
                setIfEmpty('default_email', values.DEFAULT_EMAIL ?? values.DEFAULT_EMAIL);
                setIfEmpty('default_password', values.DEFAULT_PASSWORD ?? '');

                // Timezone
                setIfEmpty('timezone', values.TIMEZONE ?? values.TIMEZONE);

                // Import demo checkbox ‚Äî accept '1' / 'true' / 'yes' values
                try {
                    const demoVal = (values.IMPORT_DEMO_DATA ?? values.IMPORT_DEMO) || values.IMPORT_DEMO || values.IMPORT_DEMO_DATA;
                    if (typeof demoVal !== 'undefined' && demoVal !== null) {
                        const cb = document.querySelector('[name="import_demo_data"]');
                        if (cb) cb.checked = (String(demoVal).toLowerCase() === '1' || String(demoVal).toLowerCase() === 'true' || String(demoVal).toLowerCase() === 'yes');
                    }
                } catch (e) { /* ignore */ }

                // Experimental Dashboard checkbox ‚Äî accept '1' / 'true' / 'yes' values
                try {
                    const dashVal = values.ENABLE_DASHBOARD;
                    if (typeof dashVal !== 'undefined' && dashVal !== null) {
                        const cb = document.querySelector('[name="enable_dashboard"]');
                        if (cb) cb.checked = (String(dashVal).toLowerCase() === '1' || String(dashVal).toLowerCase() === 'true' || String(dashVal).toLowerCase() === 'yes');
                    }
                } catch (e) { /* ignore */ }

                // MCP / Model Context Protocol Configuration
                setIfEmpty('mcp_server_url', values.MCP_SERVER_URL ?? 'http://127.0.0.1:9010');
                setIfEmpty('use_py_stt', values.USE_PY_STT ?? '1');
                setIfEmpty('python3_path', values.PYTHON3_PATH ?? '');

                // GROQ API Configuration
                setIfEmpty('groq_api_key', values.GROQ_API_KEY ?? '');
                setIfEmpty('groq_tts_model', values.GROQ_TTS_MODEL ?? 'playai-tts');
                setIfEmpty('groq_stt_model', values.GROQ_STT_MODEL ?? 'whisper-large-v3');

                // LLM Configuration
                setIfEmpty('llm_provider', values.LLM_PROVIDER ?? 'groq');
                setIfEmpty('llm_model', values.LLM_MODEL ?? 'openai/gpt-oss-120b');

                // Guest DB User Configuration
                setIfEmpty('db_guest_user', values.DB_GUEST_USER ?? 'guest');
                setIfEmpty('db_guest_password', values.DB_GUEST_PASSWORD ?? 'guest_password');

                // Cerebras API Configuration
                setIfEmpty('cerebras_api_key', values.CEREBRAS_API_KEY ?? '');
                setIfEmpty('cerebras_api_url', values.CEREBRAS_API_URL ?? 'https://api.cerebras.ai/v1');

                // Rate Limiting Configuration
                setIfEmpty('rate_limit_admin_percent', values.RATE_LIMIT_ADMIN_PERCENT ?? '50');
                setIfEmpty('rate_limit_user_percent', values.RATE_LIMIT_USER_PERCENT ?? '10');
                setIfEmpty('rate_limit_visitor_percent', values.RATE_LIMIT_VISITOR_PERCENT ?? '5');
                setIfEmpty('rate_limit_fallback_provider', values.RATE_LIMIT_FALLBACK_PROVIDER ?? 'cerebras');
                setIfEmpty('rate_limit_fallback_threshold', values.RATE_LIMIT_FALLBACK_THRESHOLD ?? '80');

                // TTS Rate Limiting Configuration
                setIfEmpty('tts_limit_admin_hourly', values.TTS_LIMIT_ADMIN_HOURLY ?? '100');
                setIfEmpty('tts_limit_user_hourly', values.TTS_LIMIT_USER_HOURLY ?? '30');
                setIfEmpty('tts_limit_visitor_session', values.TTS_LIMIT_VISITOR_SESSION ?? '10');
                setIfEmpty('tts_silent_stop_percent', values.TTS_SILENT_STOP_PERCENT ?? '90');

                // Default Provider Configuration
                setIfEmpty('default_provider', values.DEFAULT_PROVIDER ?? 'cerebras');

                // Token Limits per User Tier
                setIfEmpty('max_tokens_base', values.MAX_TOKENS_BASE ?? '32768');
                setIfEmpty('max_tokens_admin_percent', values.MAX_TOKENS_ADMIN_PERCENT ?? '100');
                setIfEmpty('max_tokens_user_percent', values.MAX_TOKENS_USER_PERCENT ?? '25');
                setIfEmpty('max_tokens_visitor_percent', values.MAX_TOKENS_VISITOR_PERCENT ?? '10');

                // Per-User Rate Limiting
                setIfEmpty('expected_users', values.EXPECTED_USERS ?? '200');

                // Security Settings
                setIfEmpty('csrf_bypass', values.CSRF_BYPASS ?? 'true');

                // HuggingFace Model Configuration (for auto-starting llama-server)
                setIfEmpty('reasoning_hf_model', values.REASONING_HF_MODEL ?? 'lm-kit/qwen-3-0.6b-instruct-gguf');
                setIfEmpty('vision_hf_model', values.VISION_HF_MODEL ?? 'ggml-org/SmolVLM2-500M-Video-Instruct-GGUF');

                // Local LLM Configuration
                setIfEmpty('local_llm_url', values.LOCAL_LLM_URL ?? 'http://127.0.0.1:8034/v1');
                setIfEmpty('local_llm_model', values.LOCAL_LLM_MODEL ?? 'local');

                // Vision Model Configuration
                setIfEmpty('vision_model_url', values.VISION_MODEL_URL ?? 'http://127.0.0.1:8033/v1');
                setIfEmpty('vision_model_name', values.VISION_MODEL_NAME ?? 'SmolVLM2');

            } catch (e) {
                console.debug('Prefill skipped:', e.message || e);
            }
        });
    </script>
    <style>
        /* hide step panels by default; only the active one will show */
        .step { display: none; }
        .step.active { display: block; }
        .step-indicator { opacity: 0.5; width: 2rem; height: 2rem; }
        .step-indicator.active { opacity: 1; }
        .step-indicator.completed { opacity: 1; background-color: #10b981; }
        /* ensure inputs have a consistent height and rhythm */
        .step input[type="text"],
        .step input[type="password"],
        .step input[type="email"],
        .step select { min-height: 3rem; }
        /* Toast animation */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-2">Ginto CMS</h1>
                <p class="text-lg text-gray-600 dark:text-gray-300">Welcome to the installation wizard</p>
            <div id="installation-status-notice" class="mb-6" style="display: none;">
                        <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                                <div>
                                    <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-200">Installation Status</h3>
                                    <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">
                                        <span id="status-message">Checking installation status...</span>
                                        <span id="force-option" style="display: none;"><br><a href="?force=1" class="underline hover:no-underline">Click here to force reinstallation</a></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Progress Steps -->
            <div class="flex justify-center mb-8">
                <div class="flex items-center space-x-4">
                    <div class="step-indicator active flex items-center justify-center w-10 h-10 rounded-full bg-blue-500 text-white font-bold" data-step="1">1</div>
                    <div class="w-16 h-1 bg-gray-300 dark:bg-gray-600"></div>
                    <div class="step-indicator flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 font-bold" data-step="2">2</div>
                    <div class="w-16 h-1 bg-gray-300 dark:bg-gray-600"></div>
                    <div class="step-indicator flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 font-bold" data-step="3">3</div>
                    <div class="w-16 h-1 bg-gray-300 dark:bg-gray-600"></div>
                    <div class="step-indicator flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 font-bold" data-step="4">4</div>
                    <div class="w-16 h-1 bg-gray-300 dark:bg-gray-600"></div>
                                            <div class="step-indicator" data-step="5">
                            <div class="step-number">5</div>
                            <div class="step-title">Verify</div>
                        </div>
                        <div class="step-indicator" data-step="6">
                            <div class="step-number">6</div>
                            <div class="step-title">Install</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Installation Form -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden">
                <form id="installForm">
                    <!-- Step 1: System Requirements -->
                    <div class="step active" data-step="1">
                        <div class="p-8">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">System Requirements Check</h2>
                            <div id="requirements-check">
                                <div class="space-y-4">
                                    <div class="flex items-center p-4 border rounded-lg" id="php-check">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Checking PHP version (7.4+ required)...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="database-check">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Checking database support (SQLite/MySQL)...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="writable-check">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Checking file permissions...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="extensions-check">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Checking required PHP extensions...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button type="button" id="next-btn-1" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="console.log('Button clicked'); nextStep(2)">
                                    Next: Database Configuration
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Database Configuration -->
                    <div class="step" data-step="2">
                        <div class="p-8">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Database Configuration</h2>
                            <div class="space-y-4">
                                <div>
                                    <select name="db_type" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="toggleDatabaseFields()">
                                        <option value="mysql">MySQL (Recommended)</option>
                                        <option value="sqlite">SQLite</option>
                                    </select>
                                </div>
                                <div id="sqlite-fields">
                                    <input type="text" name="db_file" value="database.sqlite" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Database File (e.g. database.sqlite)">
                                </div>
                                <div id="mysql-fields" class="space-y-4" style="display: none;">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <input type="text" name="db_host" value="localhost" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Host (e.g. localhost)">
                                        </div>
                                        <div>
                                            <input type="number" name="db_port" value="3306" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Port (e.g. 3306)">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <input type="text" name="db_name" value="ginto" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Database Name (e.g. ginto)" required>
                                        </div>
                                        <div>
                                            <input type="text" name="db_user" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Username" required>
                                        </div>
                                    </div>
                                    <div>
                                        <input type="password" name="db_pass" id="database_password_field" autocomplete="new-password" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Database Password">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6">
                                <button type="button" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="testDatabaseConnection()">
                                    Test Connection
                                </button>
                                <div id="db-test-result" class="mt-2"></div>
                            </div>
                            <div class="mt-8 flex justify-between">
                                <button type="button" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600" onclick="previousStep(1)">
                                    Back
                                </button>
                                <button type="button" id="next-btn-2" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="nextStep(3)">
                                    Next: Site Configuration
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Site Configuration -->
                    <div class="step" data-step="3">
                        <div class="p-8">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Site Configuration</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="col-span-full">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Site Name</label>
                                    <input type="text" name="site_name" value="Ginto CMS" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="My Website">
                                </div>
                                <div class="col-span-full">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Site Description</label>
                                    <textarea name="site_description" rows="3" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="A brief description of your website"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Site URL</label>
                                    <input type="url" name="site_url" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="https://example.com" id="site_url">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Timezone</label>
                                    <select name="timezone" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">Eastern Time (US/Canada)</option>
                                        <option value="America/Chicago">Central Time (US/Canada)</option>
                                        <option value="America/Denver">Mountain Time (US/Canada)</option>
                                        <option value="America/Los_Angeles">Pacific Time (US/Canada)</option>
                                        <option value="Europe/London">London</option>
                                        <option value="Europe/Paris">Paris</option>
                                        <option value="Asia/Tokyo">Tokyo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-between">
                                <button type="button" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600" onclick="previousStep(2)">
                                    Back
                                </button>
                                <button type="button" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="nextStep(4)">
                                    Next: Admin Account
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Admin Account -->
                    <div class="step" data-step="4">
                        <div class="p-8">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Create Admin Account</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name</label>
                                    <input type="text" name="admin_first_name" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="John" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Middle Name</label>
                                    <input type="text" name="admin_middle_name" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Middle">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name</label>
                                    <input type="text" name="admin_last_name" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Doe" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                                    <input type="email" name="admin_email" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="admin@example.com" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                                    <input type="text" name="admin_username" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="admin" required>
                                </div>
                                <div class="relative flex flex-col">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                                    <div class="relative">
                                        <input type="password" id="admin_password" name="admin_password" class="w-full p-3 pr-12 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter secure admin password" aria-describedby="admin-password-hint" required>
                                        <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center px-2 text-gray-500" style="transform: translateY(-50%);" onclick="togglePassword('admin_password', this)" aria-label="Toggle admin password visibility" aria-pressed="false">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                    </div>
                                    <p id="admin-password-hint" class="text-sm text-gray-500 mt-2">Minimum 6 characters</p>
                                </div>
                            </div>

                            <div class="mt-8 p-6 bg-blue-100 dark:bg-blue-900/40 border border-blue-200 dark:border-blue-700 rounded-xl">
                                <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">Default User Account</h3>
                                <p class="text-sm text-blue-700 dark:text-blue-300 mb-4">Create the first user account (001) for your Ginto system:</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-blue-700 dark:text-blue-300 mb-1">Default Username</label>
                                        <input type="text" name="default_username" class="w-full p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter username" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-700 dark:text-blue-300 mb-1">Default Email</label>
                                        <input type="email" name="default_email" class="w-full p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter email" required>
                                    </div>
                                    <div class="relative flex flex-col">
                                        <label class="block text-sm font-medium text-blue-700 dark:text-blue-300 mb-1">Default Password</label>
                                        <div class="relative">
                                            <input type="password" name="default_password" class="w-full p-3 pr-12 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter password" aria-describedby="default-password-hint" required>
                                            <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center px-2 text-gray-500" style="transform: translateY(-50%);" onclick="togglePassword('default_password', this)" aria-label="Toggle default user password visibility" aria-pressed="false">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                            </button>
                                        </div>
                                        <p id="default-password-hint" class="text-sm text-gray-500 mt-2">Minimum 6 characters</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <label class="flex items-center">
                                    <input type="checkbox" name="import_demo_data" class="mr-2" checked>
                                    <span class="text-gray-700 dark:text-gray-300">Import demo content (recommended)</span>
                                </label>
                            </div>
                            <div class="mt-8 flex justify-between">
                                <button type="button" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600" onclick="previousStep(3)">
                                    Back
                                </button>
                                <button type="button" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="nextStep(5)">
                                    Next: Verify & Configure
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Verification -->
                    <div class="step" data-step="5">
                        <div class="p-8">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Verify Installation Settings</h2>
                            <p class="text-gray-600 dark:text-gray-300 mb-6">Please verify all settings before proceeding with the installation:</p>
                            
                            <div class="space-y-6">
                                <!-- Site Configuration -->
                                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Site Configuration</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><strong>Site Name:</strong> <span id="verify-site-name"></span></div>
                                        <div><strong>Site URL:</strong> <span id="verify-site-url"></span></div>
                                    </div>
                                </div>
                                
                                <!-- Database Configuration -->
                                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-3">Database Configuration</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><strong>Database Type:</strong> <span id="verify-db-type"></span></div>
                                        <div><strong>Database Host:</strong> <span id="verify-db-host"></span></div>
                                        <div><strong>Database Port:</strong> <span id="verify-db-port"></span></div>
                                        <div><strong>Database Name:</strong> <span id="verify-db-name"></span></div>
                                        <div><strong>Database User:</strong> <span id="verify-db-user"></span></div>
                                        <div><strong>Database Password:</strong> <span id="verify-db-pass"></span></div>
                                    </div>
                                </div>
                                
                                <!-- Admin Account -->
                                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-green-800 dark:text-green-200 mb-3">Admin Account</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><strong>First Name:</strong> <span id="verify-admin-fname"></span></div>
                                        <div><strong>Middle Name:</strong> <span id="verify-admin-mname"></span></div>
                                        <div><strong>Last Name:</strong> <span id="verify-admin-lname"></span></div>
                                        <div><strong>Email:</strong> <span id="verify-admin-email"></span></div>
                                        <div><strong>Username:</strong> <span id="verify-admin-username"></span></div>
                                        <div><strong>Password:</strong> <span id="verify-admin-password"></span></div>
                                    </div>
                                </div>
                                
                                <!-- Default User Account -->
                                <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-3">Default User Account</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div><strong>Username:</strong> <span id="verify-default-username"></span></div>
                                        <div><strong>Email:</strong> <span id="verify-default-email"></span></div>
                                        <div><strong>Password:</strong> <span id="verify-default-password"></span></div>
                                    </div>
                                </div>
                                    
                                <!-- Advanced Options Section -->
                                <div class="col-span-full mt-6">
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 border-b pb-2 border-gray-300 dark:border-gray-600">Advanced Options</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Enable optional integrations below. These are not required for basic functionality.</p>
                                    
                                    <div class="space-y-4">
                                        <!-- PayPal Integration Checkbox -->
                                        <div class="flex items-center">
                                            <input type="checkbox" id="enable_paypal" name="enable_paypal" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" onchange="toggleSection('paypal_section', this.checked)">
                                            <label for="enable_paypal" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Enable PayPal Integration</label>
                                        </div>
                                        
                                        <!-- Backblaze B2 Checkbox -->
                                        <div class="flex items-center">
                                            <input type="checkbox" id="enable_b2" name="enable_b2" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" onchange="toggleSection('b2_section', this.checked)">
                                            <label for="enable_b2" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Enable Backblaze B2 Cloud Storage</label>
                                        </div>
                                        
                                        <!-- Cerebras Checkbox -->
                                        <div class="flex items-center">
                                            <input type="checkbox" id="enable_cerebras" name="enable_cerebras" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" onchange="toggleCerebras(this.checked)">
                                            <label for="enable_cerebras" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Enable Cerebras <span class="text-xs text-blue-500">(fast inference)</span></label>
                                        </div>
                                        
                                        <!-- Groq Checkbox -->
                                        <div class="flex items-center">
                                            <input type="checkbox" id="enable_groq" name="enable_groq" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" onchange="toggleGroq(this.checked)">
                                            <label for="enable_groq" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Enable Groq <span class="text-xs text-blue-500">(enables TTS/STT and fast inference)</span></label>
                                        </div>
                                        
                                        <!-- TTS Checkbox (requires Groq) -->
                                        <div class="flex items-center" id="tts_checkbox_wrapper">
                                            <input type="checkbox" id="enable_tts" name="enable_tts" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" onchange="toggleSection('tts_section', this.checked)" disabled>
                                            <label for="enable_tts" class="ml-3 text-sm font-medium text-gray-500 dark:text-gray-400">üîä Enable TTS/STT <span class="text-xs text-gray-400">(requires Groq)</span></label>
                                        </div>
                                        
                                        <!-- Reasoning Model Checkbox -->
                                        <div class="flex items-center">
                                            <input type="checkbox" id="enable_local_llm" name="enable_local_llm" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" onchange="toggleSection('local_llm_section', this.checked)" checked>
                                            <label for="enable_local_llm" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">üß† Enable Reasoning Model (llama.cpp) <span class="text-xs text-green-500">(local CPU inference on port 8034)</span></label>
                                        </div>
                                        
                                        <!-- Cloud LLM Checkbox -->
                                        <div class="flex items-center">
                                            <input type="checkbox" id="enable_cloud_llm" name="enable_cloud_llm" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600" onchange="toggleSection('llm_section', this.checked)">
                                            <label for="enable_cloud_llm" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">‚òÅÔ∏è Enable Cloud LLM <span class="text-xs text-gray-500">(Groq, Cerebras, OpenAI, etc.)</span></label>
                                        </div>
                                        
                                        <!-- Experimental Dashboard Checkbox -->
                                        <div class="flex items-center mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                            <input type="checkbox" id="enable_dashboard" name="enable_dashboard" class="w-5 h-5 text-amber-600 rounded focus:ring-amber-500 dark:bg-gray-700 dark:border-gray-600">
                                            <label for="enable_dashboard" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">
                                                üß™ Enable Experimental Dashboard 
                                                <span class="text-xs text-amber-500 dark:text-amber-400">(Beta - Repo Invitation System)</span>
                                            </label>
                                        </div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 ml-8 mt-1">
                                            ‚ö†Ô∏è This is an unfinished feature for repository invitations and collaboration. Enable only if you want to test experimental functionality.
                                        </p>
                                    </div>
                                    
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-3 italic">üí° Tip: For fully local setup, just enable Reasoning Model (port 8034) and Vision Model (port 8033). Cloud LLM and TTS are optional.</p>
                                </div>

                                <!-- PayPal Configuration Section (hidden by default) -->
                                <div id="paypal_section" class="col-span-full mt-4 hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">PayPal API Configuration</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Enter PayPal credentials for both sandbox and live environments.</p>
                                    
                                    <!-- Sandbox Credentials -->
                                    <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg mb-4">
                                        <h4 class="text-md font-semibold text-yellow-800 dark:text-yellow-300 mb-3">Sandbox Credentials (Testing)</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sandbox Client ID</label>
                                                <input type="text" name="paypal_sandbox_client_id" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Sandbox Client ID">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sandbox Client Secret</label>
                                                <input type="password" name="paypal_sandbox_client_secret" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Sandbox Client Secret">
                                            </div>
                                            <div class="col-span-full">
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sandbox Webhook ID</label>
                                                <input type="text" name="paypal_sandbox_webhook_id" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Sandbox Webhook ID">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Live Credentials -->
                                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg mb-4">
                                        <h4 class="text-md font-semibold text-green-800 dark:text-green-300 mb-3">Live Credentials (Production)</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Live Client ID</label>
                                                <input type="text" name="paypal_client_id" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Live Client ID">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Live Client Secret</label>
                                                <input type="password" name="paypal_client_secret" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Live Client Secret">
                                            </div>
                                            <div class="col-span-full">
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Live Webhook ID</label>
                                                <input type="text" name="paypal_webhook_id" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Live Webhook ID">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Environment & Internal Key -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Active Environment</label>
                                            <select name="paypal_environment" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <option value="sandbox" selected>sandbox</option>
                                                <option value="live">live</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">PayPal Internal API Key</label>
                                            <div class="flex gap-2">
                                                <input type="text" name="paypal_internal_api_key" id="paypal_internal_api_key" class="flex-1 p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white font-mono text-sm" placeholder="Auto-generated secure key">
                                                <button type="button" onclick="generatePayPalInternalKey()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Generate</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Backblaze B2 Configuration Section (hidden by default) -->
                                <div id="b2_section" class="col-span-full mt-4 hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Backblaze B2 Cloud Storage</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure Backblaze B2 for file storage and CDN.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">B2 Account ID</label>
                                            <input type="text" name="b2_account_id" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="B2 Account ID">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">B2 App Key</label>
                                            <input type="password" name="b2_app_key" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="B2 App Key">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">B2 Bucket ID</label>
                                            <input type="text" name="b2_bucket_id" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="B2 Bucket ID">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">B2 Bucket Name</label>
                                            <input type="text" name="b2_bucket_name" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="B2 Bucket Name">
                                        </div>
                                        <div class="col-span-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CDN Base URL</label>
                                            <input type="url" name="file_cdn_base_url" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="https://cdn.example.com">
                                        </div>
                                    </div>
                                </div>

                                <!-- MCP / Model Context Protocol Configuration -->
                                <div class="col-span-full mt-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">MCP / Model Context Protocol Configuration</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure MCP server and AI/Speech services integration.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">MCP Server URL</label>
                                            <input type="url" name="mcp_server_url" value="http://127.0.0.1:9010" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="http://127.0.0.1:9010">
                                        </div>
                                    </div>
                                </div>

                                <!-- GROQ API Configuration (hidden by default) -->
                                <div id="groq_section" class="col-span-full mt-4 hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Groq API Configuration</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Enter your Groq API key. This enables fast inference and TTS/STT capabilities.</p>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Groq API Key</label>
                                            <input type="password" name="groq_api_key" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="gsk_...">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Get your API key from <a href="https://console.groq.com/keys" target="_blank" class="text-blue-500 hover:underline">console.groq.com/keys</a></p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-blue-600 dark:text-blue-400 mt-3 italic">üí° Enable TTS/STT in Advanced Options above to configure speech settings.</p>
                                </div>

                                <!-- Cloud LLM Configuration (hidden by default) -->
                                <div id="llm_section" class="col-span-full mt-6 hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Cloud LLM Configuration</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure cloud LLM provider and model for AI assistant. Skip if using local models only.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">LLM Provider</label>
                                            <select name="llm_provider" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <option value="local" selected>Local Only (No Cloud)</option>
                                                <option value="groq">Groq</option>
                                                <option value="cerebras">Cerebras</option>
                                                <option value="openai">OpenAI</option>
                                                <option value="anthropic">Anthropic</option>
                                                <option value="ollama">Ollama (Local)</option>
                                                <option value="llamacpp">llama.cpp (Local)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">LLM Model</label>
                                            <select name="llm_model" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <optgroup label="Local Models">
                                                    <option value="local" selected>Use Local Reasoning Model</option>
                                                </optgroup>
                                                <optgroup label="Groq Models">
                                                    <option value="openai/gpt-oss-120b">openai/gpt-oss-120b (Recommended)</option>
                                                    <option value="llama-3.3-70b-versatile">llama-3.3-70b-versatile</option>
                                                    <option value="llama-3.1-70b-versatile">llama-3.1-70b-versatile</option>
                                                    <option value="llama-3.1-8b-instant">llama-3.1-8b-instant</option>
                                                    <option value="mixtral-8x7b-32768">mixtral-8x7b-32768</option>
                                                    <option value="gemma2-9b-it">gemma2-9b-it</option>
                                                </optgroup>
                                                <optgroup label="OpenAI Models">
                                                    <option value="gpt-4o">gpt-4o</option>
                                                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                                                    <option value="gpt-4-turbo">gpt-4-turbo</option>
                                                </optgroup>
                                                <optgroup label="Anthropic Models">
                                                    <option value="claude-3-5-sonnet-20241022">claude-3-5-sonnet</option>
                                                    <option value="claude-3-opus-20240229">claude-3-opus</option>
                                                    <option value="claude-3-haiku-20240307">claude-3-haiku</option>
                                                </optgroup>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Select a model or type a custom model name</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Guest DB User Configuration -->
                                <div class="col-span-full mt-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Guest Database User (MCP Clients)</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure read-only guest user for MCP client database access.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Guest Username</label>
                                            <input type="text" name="db_guest_user" value="guest" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="guest">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Guest Password</label>
                                            <input type="password" name="db_guest_password" value="guest_password" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="guest_password">
                                        </div>
                                    </div>
                                </div>

                                <!-- Cerebras API Configuration (hidden by default) -->
                                <div id="cerebras_section" class="col-span-full mt-4 hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Cerebras API Configuration</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure Cerebras for fast LLM inference.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="col-span-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cerebras API Key</label>
                                            <input type="password" name="cerebras_api_key" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="csk-...">
                                        </div>
                                        <div class="col-span-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cerebras API URL</label>
                                            <input type="text" name="cerebras_api_url" value="https://api.cerebras.ai/v1" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="https://api.cerebras.ai/v1">
                                        </div>
                                    </div>
                                </div>

                                <!-- Vision Model Configuration (Eyes subserve the mind) -->
                                <div class="col-span-full mt-6">
                                    <div class="flex items-center mb-4">
                                        <input type="checkbox" id="enable_vision" name="enable_vision" class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500" onchange="toggleSection('vision_section', this.checked)" checked>
                                        <label for="enable_vision" class="ml-3 text-lg font-semibold text-gray-800 dark:text-white">üëÅÔ∏è Enable Vision Model</label>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure a vision-capable model for image understanding. Uses llama.cpp compatible API.</p>
                                </div>

                                <div id="vision_section" class="col-span-full">
                                    <div class="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 p-4 rounded-lg mb-4">
                                        <p class="text-sm text-purple-800 dark:text-purple-200 mb-2"><strong>üëÅÔ∏è Vision Model:</strong> Enable image understanding with a lightweight vision model.</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Enter a HuggingFace vision model and we'll start llama-server for you:</p>
                                        <code class="block bg-gray-900 text-green-400 p-3 rounded text-xs font-mono overflow-x-auto">
llama-server -hf ggml-org/SmolVLM2-500M-Video-Instruct-GGUF --jinja -c 0 --host 127.0.0.1 --port 8033
                                        </code>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">SmolVLM2 is a super fast vision model that runs on CPU!</p>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="col-span-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ü§ó HuggingFace Vision Model</label>
                                            <input type="text" name="vision_hf_model" value="ggml-org/SmolVLM2-500M-Video-Instruct-GGUF" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white font-mono text-sm" placeholder="ggml-org/SmolVLM2-500M-Video-Instruct-GGUF">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">HuggingFace GGUF vision model. Leave empty to skip auto-start.</p>
                                        </div>
                                        <div class="col-span-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vision Model Server URL</label>
                                            <input type="url" name="vision_model_url" value="http://127.0.0.1:8033/v1" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="http://127.0.0.1:8033/v1">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">OpenAI-compatible vision API. For Ollama: http://127.0.0.1:11434/v1 (use llava or similar)</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vision Model Name</label>
                                            <input type="text" name="vision_model_name" value="SmolVLM2" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="SmolVLM2">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Model name (e.g., SmolVLM2, llava, moondream)</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Max Tokens for Vision</label>
                                            <input type="number" name="vision_max_tokens" value="512" min="64" max="4096" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="512">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Maximum tokens for vision model responses</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Reasoning Model (llama.cpp) Configuration -->
                                <div id="local_llm_section" class="col-span-full mt-4">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">üß† Reasoning Model (llama.cpp / Ollama)</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Ginto is a lightweight webui bundled with dev tools. Configure a local reasoning model - works great on CPU!</p>
                                    <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 p-4 rounded-lg mb-4">
                                        <p class="text-sm text-blue-800 dark:text-blue-200 mb-2"><strong>üß† Reasoning Model:</strong> For chat, coding, and reasoning tasks. llama.cpp runs efficiently on CPU - no GPU required!</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Enter a HuggingFace model and we'll start llama-server for you:</p>
                                        <code class="block bg-gray-900 text-green-400 p-3 rounded text-xs font-mono overflow-x-auto">
llama-server -hf lm-kit/qwen-3-0.6b-instruct-gguf -c 0 --host 127.0.0.1 --port 8034
                                        </code>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="col-span-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ü§ó HuggingFace Reasoning Model</label>
                                            <input type="text" name="reasoning_hf_model" value="lm-kit/qwen-3-0.6b-instruct-gguf" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white font-mono text-sm" placeholder="lm-kit/qwen-3-0.6b-instruct-gguf">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">HuggingFace GGUF model. Leave empty to skip auto-start. Examples: lm-kit/qwen-3-0.6b-instruct-gguf, TheBloke/Mistral-7B-Instruct-v0.2-GGUF</p>
                                        </div>
                                        <div class="col-span-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reasoning Model Server URL</label>
                                            <input type="url" name="local_llm_url" value="http://127.0.0.1:8034/v1" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="http://127.0.0.1:8034/v1">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">OpenAI-compatible API endpoint. For Ollama use: http://127.0.0.1:11434/v1</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reasoning Model Name</label>
                                            <input type="text" name="local_llm_model" value="local" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="local">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Model identifier (use 'local' or model name from /v1/models)</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Use as Primary Provider</label>
                                            <select name="local_llm_primary" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <option value="0" selected>No (Fallback only)</option>
                                                <option value="1">Yes (Primary provider)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use reasoning model as primary instead of cloud APIs</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rate Limiting Configuration -->
                                <div class="col-span-full mt-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Rate Limiting Configuration</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure API usage limits per user tier (percentage of organization limit).</p>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin Limit (%)</label>
                                            <input type="number" name="rate_limit_admin_percent" value="50" min="1" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="50">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">% of org limit for admins</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">User Limit (%)</label>
                                            <input type="number" name="rate_limit_user_percent" value="10" min="1" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="10">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">% of org limit for users</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Visitor Limit (%)</label>
                                            <input type="number" name="rate_limit_visitor_percent" value="5" min="1" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="5">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">% of org limit for visitors</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fallback Provider</label>
                                            <select id="rate_limit_fallback_provider" name="rate_limit_fallback_provider" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <option value="none" selected>None (Block requests)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Provider to use when primary rate limit is reached (enable providers in Advanced Options)</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fallback Threshold (%)</label>
                                            <input type="number" name="rate_limit_fallback_threshold" value="80" min="50" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="80">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Switch to fallback when usage exceeds this %</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- TTS Configuration (hidden by default, requires Groq) -->
                                <div id="tts_section" class="col-span-full mt-6 hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">üîä TTS/STT Configuration</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure Text-to-Speech and Speech-to-Text settings. Requires Groq API.</p>
                                    
                                    <!-- TTS Model Settings -->
                                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-200 mb-3">Model Settings</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">TTS Model</label>
                                            <input type="text" name="groq_tts_model" value="playai-tts" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="playai-tts">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Groq TTS model (playai-tts recommended)</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">STT Model</label>
                                            <input type="text" name="groq_stt_model" value="whisper-large-v3" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="whisper-large-v3">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Groq STT model (whisper-large-v3 recommended)</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Python STT Settings -->
                                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-200 mb-3 mt-4">Python STT (Optional)</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Use Python STT</label>
                                            <select name="use_py_stt" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <option value="0" selected>No (Use Groq)</option>
                                                <option value="1">Yes (Local Python)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use local Python whisper instead of Groq</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Python3 Path</label>
                                            <input type="text" name="python3_path" value="/usr/bin/python3" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="/usr/bin/python3">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Path to Python 3 executable</p>
                                        </div>
                                    </div>
                                    
                                    <!-- TTS Rate Limiting -->
                                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-200 mb-3 mt-4">Rate Limiting</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin (per hour)</label>
                                            <input type="number" name="tts_limit_admin_hourly" value="100" min="1" max="1000" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="100">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">TTS requests/hour for admins</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">User (per hour)</label>
                                            <input type="number" name="tts_limit_user_hourly" value="30" min="1" max="500" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="30">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">TTS requests/hour for users</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Visitor (per session)</label>
                                            <input type="number" name="tts_limit_visitor_session" value="10" min="1" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="10">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">TTS requests/session for visitors</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Silent Stop (%)</label>
                                            <input type="number" name="tts_silent_stop_percent" value="90" min="50" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="90">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Silently stop TTS at this org usage %</p>
                                        </div>
                                    </div>
                                    
                                    <p class="text-sm text-green-600 dark:text-green-400 mt-4 italic">‚úÖ TTS/STT uses your Groq API key configured above.</p>
                                </div>

                                <!-- Default Provider Configuration (hidden when no cloud providers enabled) -->
                                <div id="default_provider_section" class="col-span-full mt-6 hidden">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Default Chat Provider</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Choose the primary LLM provider for chat. Local models are used when no cloud provider is available.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Default Provider</label>
                                            <select id="default_provider" name="default_provider" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <option value="local" selected>Local Model (llama.cpp)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Your local model is used when cloud is unavailable</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expected Users</label>
                                            <input type="number" name="expected_users" value="200" min="1" max="10000" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="200">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Used to calculate per-user rate limits</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Token Limits per User Tier -->
                                <div class="col-span-full mt-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Token Limits per User Tier</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure maximum tokens per response based on user role.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Base Token Limit</label>
                                            <input type="number" name="max_tokens_base" value="32768" min="1024" max="131072" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="32768">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Model context window</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin (%)</label>
                                            <input type="number" name="max_tokens_admin_percent" value="100" min="1" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="100">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">% of base for admins</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">User (%)</label>
                                            <input type="number" name="max_tokens_user_percent" value="25" min="1" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="25">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">% of base for users</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Visitor (%)</label>
                                            <input type="number" name="max_tokens_visitor_percent" value="10" min="1" max="100" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="10">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">% of base for visitors</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security Settings -->
                                <div class="col-span-full mt-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Security Settings</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Configure security options for the chat interface.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CSRF Bypass for Visitors</label>
                                            <select name="csrf_bypass" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                <option value="true">Enabled (allow visitor chat)</option>
                                                <option value="false">Disabled (require login for chat)</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enable to allow visitors to use chat without logging in</p>
                                        </div>
                                    </div>
                                </div>

                                </div>
                            </div>
                            
                            <!-- Step 5 Navigation Buttons -->
                            <div class="mt-8 py-8 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex justify-between items-center mx-8">
                                    <button type="button" onclick="previousStep(4)" class="flex items-center gap-2 px-6 py-3 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                        Back
                                    </button>
                                    <button type="button" onclick="startInstallation()" class="flex items-center gap-2 px-8 py-3 bg-blue-500 text-white rounded-lg font-semibold text-lg hover:bg-blue-600 transition-colors">
                                        Start Installation
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 6: Installation -->
                    <div class="step" data-step="6">
                        <div class="p-8">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Installing Ginto CMS</h2>
                            <div id="installation-progress">
                                <div class="space-y-4">
                                    <div class="flex items-center p-4 border rounded-lg" id="create-config">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Creating configuration files...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="setup-database">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Setting up database...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="run-migrations">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Running database migrations...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="create-admin">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Creating admin account...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="import-demo">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Importing demo content...</span>
                                    </div>
                                    <div class="flex items-center p-4 border rounded-lg" id="finalize">
                                        <div class="w-6 h-6 mr-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300">Finalizing installation...</span>
                                    </div>
                                </div>
                            </div>
                            <div id="installation-complete" style="display: none;">
                                <div class="text-center">
                                    <div class="w-16 h-16 mx-auto mb-4 text-green-500">
                                        <svg fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-2xl font-bold text-green-600 mb-2">Installation Complete!</h3>
                                    <p class="text-gray-600 dark:text-gray-300 mb-6">Your Ginto CMS installation is ready to use.</p>
                                    
                                    <div class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg p-4 mb-6">
                                        <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">‚úÖ All Set!</h4>
                                        <p class="text-green-700 dark:text-green-300 text-sm">
                                            Your database has been set up, admin account created, and all configurations are in place. 
                                            You can now access your CMS using the buttons below.
                                        </p>
                                    </div>
                                    
                                    <!-- llama.cpp Boot Persistence Instructions -->
                                    <div class="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 rounded-lg p-4 mb-6 text-left">
                                        <h4 class="font-semibold text-purple-800 dark:text-purple-200 mb-3">üß† Enable AI Models on Boot (Optional)</h4>
                                        <p class="text-purple-700 dark:text-purple-300 text-sm mb-3">
                                            To make AI models start automatically on system boot, 
                                            log in as admin and run this command in the <strong>Console</strong>:
                                        </p>
                                        <div class="flex items-center bg-gray-900 rounded mb-3">
                                            <code id="llama-boot-cmd" class="flex-1 text-green-400 p-3 text-sm font-mono">sudo bash ~/ginto/bin/setup_llama_boot.sh</code>
                                            <button type="button" onclick="copyLlamaCmd()" class="p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-r transition-colors" title="Copy to clipboard">
                                                <svg id="copy-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                                <svg id="check-icon" class="w-5 h-5 hidden text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                            </button>
                                        </div>
                                        <p class="text-xs text-purple-600 dark:text-purple-400 mb-4">
                                            üí° This only needs to be run once. After that, models will auto-start on every boot.
                                        </p>
                                        <div class="mt-4">
                                            <img src="../assets/images/success.png" alt="Console location in sidebar" class="rounded-lg border border-purple-300 dark:border-purple-700 shadow-lg max-w-full md:max-w-[400px] mx-auto">
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <a href="../admin" target="_blank" class="inline-block px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 mr-4">
                                            Access Admin Panel (New Tab)
                                        </a>
                                        <a href="../" target="_blank" class="inline-block px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                            View Your Site (New Tab)
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-between">
                                <button type="button" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600" onclick="previousStep(5)" id="back-btn-6">
                                    Back
                                </button>
                                <button type="button" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="startInstallation()" id="install-btn">
                                    Start Installation
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Generate a secure random hex key for PayPal Internal API Key
        function generatePayPalInternalKey() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            const hexKey = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            document.getElementById('paypal_internal_api_key').value = hexKey;
        }

        // Show toast notification
        function showToast(message, duration = 2000) {
            // Remove existing toast if any
            const existingToast = document.getElementById('copy-toast');
            if (existingToast) existingToast.remove();
            
            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'copy-toast';
            toast.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 animate-fade-in';
            toast.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Copy llama boot command to clipboard
        function copyLlamaCmd() {
            const cmd = document.getElementById('llama-boot-cmd').textContent;
            
            // Try modern clipboard API first, fallback to execCommand for HTTP sites
            function copySuccess() {
                const copyIcon = document.getElementById('copy-icon');
                const checkIcon = document.getElementById('check-icon');
                copyIcon.classList.add('hidden');
                checkIcon.classList.remove('hidden');
                showToast('Copied to clipboard!');
                setTimeout(() => {
                    copyIcon.classList.remove('hidden');
                    checkIcon.classList.add('hidden');
                }, 2000);
            }
            
            function copyFailed() {
                showToast('Failed to copy. Please select and copy manually.', 3000);
            }
            
            // Modern clipboard API (requires HTTPS or localhost)
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(cmd).then(copySuccess).catch(copyFailed);
            } else {
                // Fallback for HTTP: use execCommand
                const textArea = document.createElement('textarea');
                textArea.value = cmd;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        copySuccess();
                    } else {
                        copyFailed();
                    }
                } catch (err) {
                    copyFailed();
                }
                document.body.removeChild(textArea);
            }
        }

        // Toggle visibility of advanced option sections
        function toggleSection(sectionId, show) {
            const section = document.getElementById(sectionId);
            if (section) {
                if (show) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            }
        }
        
        // Toggle Groq - enables/disables TTS option and updates fallback provider
        function toggleGroq(enabled) {
            toggleSection('groq_section', enabled);
            
            const ttsCheckbox = document.getElementById('enable_tts');
            const ttsLabel = ttsCheckbox.parentElement.querySelector('label');
            
            if (enabled) {
                ttsCheckbox.disabled = false;
                ttsLabel.classList.remove('text-gray-500', 'dark:text-gray-400');
                ttsLabel.classList.add('text-gray-700', 'dark:text-gray-300');
                ttsLabel.innerHTML = 'üîä Enable TTS/STT <span class="text-xs text-green-500">(Groq powered)</span>';
            } else {
                ttsCheckbox.disabled = true;
                ttsCheckbox.checked = false;
                toggleSection('tts_section', false);
                ttsLabel.classList.remove('text-gray-700', 'dark:text-gray-300');
                ttsLabel.classList.add('text-gray-500', 'dark:text-gray-400');
                ttsLabel.innerHTML = 'üîä Enable TTS/STT <span class="text-xs text-gray-400">(requires Groq)</span>';
            }
            
            updateFallbackProviders();
        }
        
        // Toggle Cerebras - updates fallback provider
        function toggleCerebras(enabled) {
            toggleSection('cerebras_section', enabled);
            updateFallbackProviders();
        }
        
        // Update fallback and default provider dropdowns based on enabled providers
        function updateFallbackProviders() {
            const fallbackSelect = document.getElementById('rate_limit_fallback_provider');
            const defaultProviderSelect = document.getElementById('default_provider');
            const defaultProviderSection = document.getElementById('default_provider_section');
            
            const groqEnabled = document.getElementById('enable_groq')?.checked;
            const cerebrasEnabled = document.getElementById('enable_cerebras')?.checked;
            const hasCloudProvider = groqEnabled || cerebrasEnabled;
            
            // Show/hide default provider section based on cloud providers
            if (defaultProviderSection) {
                if (hasCloudProvider) {
                    defaultProviderSection.classList.remove('hidden');
                } else {
                    defaultProviderSection.classList.add('hidden');
                }
            }
            
            // Update default provider dropdown
            if (defaultProviderSelect) {
                const currentDefaultValue = defaultProviderSelect.value;
                defaultProviderSelect.innerHTML = '';
                
                // Local is always first option
                const localOpt = document.createElement('option');
                localOpt.value = 'local';
                localOpt.textContent = 'Local Model (llama.cpp)';
                defaultProviderSelect.appendChild(localOpt);
                
                if (cerebrasEnabled) {
                    const opt = document.createElement('option');
                    opt.value = 'cerebras';
                    opt.textContent = 'Cerebras (faster, tighter limits)';
                    defaultProviderSelect.appendChild(opt);
                }
                
                if (groqEnabled) {
                    const opt = document.createElement('option');
                    opt.value = 'groq';
                    opt.textContent = 'Groq (vision support)';
                    defaultProviderSelect.appendChild(opt);
                }
                
                // Restore previous selection if still valid
                if ([...defaultProviderSelect.options].some(opt => opt.value === currentDefaultValue)) {
                    defaultProviderSelect.value = currentDefaultValue;
                }
            }
            
            // Update fallback provider dropdown  
            if (fallbackSelect) {
                const currentValue = fallbackSelect.value;
                fallbackSelect.innerHTML = '';
                
                // Local fallback is always available
                const localFallback = document.createElement('option');
                localFallback.value = 'local';
                localFallback.textContent = 'Local Model (llama.cpp)';
                fallbackSelect.appendChild(localFallback);
                
                if (cerebrasEnabled) {
                    const opt = document.createElement('option');
                    opt.value = 'cerebras';
                    opt.textContent = 'Cerebras';
                    fallbackSelect.appendChild(opt);
                }
                
                if (groqEnabled) {
                    const opt = document.createElement('option');
                    opt.value = 'groq';
                    opt.textContent = 'Groq';
                    fallbackSelect.appendChild(opt);
                }
                
                // Add none option
                const noneOpt = document.createElement('option');
                noneOpt.value = 'none';
                noneOpt.textContent = 'None (Block requests)';
                fallbackSelect.appendChild(noneOpt);
                
                // Restore previous selection if still valid
                if ([...fallbackSelect.options].some(opt => opt.value === currentValue)) {
                    fallbackSelect.value = currentValue;
                }
            }
        }

        // Auto-detect site URL and check installation status
        document.addEventListener('DOMContentLoaded', function() {
            const siteUrlInput = document.getElementById('site_url');
            if (siteUrlInput) {
                siteUrlInput.value = window.location.protocol + '//' + window.location.host;
            }
            
            // Auto-generate PayPal internal API key if empty
            const paypalKeyInput = document.getElementById('paypal_internal_api_key');
            if (paypalKeyInput && !paypalKeyInput.value) {
                generatePayPalInternalKey();
            }
            
            // Check installation status
            checkInstallationStatus();
            
            // Run initial requirements check but don't auto-advance
            checkSystemRequirements();
            
            // Make sure we start on step 1
            showStep(1);
        });
        
        // Check if installation is already complete
        async function checkInstallationStatus() {
            const statusNotice = document.getElementById('installation-status-notice');
            const statusMessage = document.getElementById('status-message');
            const forceOption = document.getElementById('force-option');
            const urlParams = new URLSearchParams(window.location.search);
            
            // If ?force=1 is in URL, show reinstallation notice
            if (urlParams.get('force') === '1') {
                statusNotice.style.display = 'block';
                statusMessage.textContent = 'Force reinstallation mode enabled. Existing installation will be overwritten.';
                // Still try to load existing .env values
                await loadExistingEnvValues();
                return;
            }
            
            // Check installation status via backend
            try {
                const statusResponse = await fetch('/install.php?action=check_status');
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    if (status.success) {
                        if (status.installed && !status.force_mode) {
                            // Installation is complete, show notice with force option
                            statusNotice.style.display = 'block';
                            statusMessage.textContent = 'Installation is already complete.';
                            forceOption.style.display = 'inline';
                            return;
                        } else if (status.env_exists && !status.installed) {
                            // Partial installation - .env exists but .installed doesn't
                            statusNotice.style.display = 'block';
                            statusMessage.textContent = 'Partial installation detected. Configuration file (.env) found. Form fields have been pre-filled. You can resume installation.';
                            await loadExistingEnvValues();
                            return;
                        } else {
                            // Fresh installation - no .env, no .installed
                            console.log('Fresh installation detected');
                            return;
                        }
                    }
                }
            } catch (error) {
                console.log('Could not check installation status:', error);
            }
            
            // Fallback: Check if .env exists (partial installation)
            try {
                const response = await fetch('/install.php?action=get_env_values');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && Object.keys(result.values).length > 0) {
                        statusNotice.style.display = 'block';
                        statusMessage.textContent = 'Configuration file (.env) detected. Form fields have been pre-filled with existing values.';
                        // Load and populate form fields with existing .env values
                        await loadExistingEnvValues();
                    } else {
                        console.log('Fresh installation detected');
                    }
                } else {
                    console.log('Fresh installation detected');
                }
            } catch (error) {
                // .env doesn't exist, fresh installation
                console.log('Fresh installation detected');
            }
        }
        
        // Load existing .env values and populate form fields
        async function loadExistingEnvValues() {
            try {
                const response = await fetch('/install.php?action=get_env_values');
                if (!response.ok) return;
                
                const result = await response.json();
                if (!result.success) {
                    console.warn('Could not load .env values:', result.message);
                    return;
                }
                
                const envValues = result.values;
                console.log('Loaded .env values:', envValues);
                
                // Populate site configuration fields
                if (envValues.APP_NAME) {
                    const siteNameField = document.querySelector('[name="site_name"]');
                    if (siteNameField) siteNameField.value = envValues.APP_NAME.replace(/^"(.*)"$/, '$1');
                }
                
                if (envValues.APP_URL) {
                    const siteUrlField = document.querySelector('[name="site_url"]');
                    if (siteUrlField) siteUrlField.value = envValues.APP_URL;
                }
                
                // Populate database configuration fields
                if (envValues.DB_TYPE) {
                    const dbTypeField = document.querySelector('[name="db_type"]');
                    if (dbTypeField) {
                        dbTypeField.value = envValues.DB_TYPE;
                        // Trigger the database fields toggle
                        toggleDatabaseFields();
                    }
                }
                
                if (envValues.DB_HOST) {
                    const dbHostField = document.querySelector('[name="db_host"]');
                    if (dbHostField) dbHostField.value = envValues.DB_HOST;
                }
                
                if (envValues.DB_PORT) {
                    const dbPortField = document.querySelector('[name="db_port"]');
                    if (dbPortField) dbPortField.value = envValues.DB_PORT;
                }
                
                if (envValues.DB_NAME) {
                    const dbNameField = document.querySelector('[name="db_name"]');
                    if (dbNameField) dbNameField.value = envValues.DB_NAME;
                }
                
                if (envValues.DB_USER) {
                    const dbUserField = document.querySelector('[name="db_user"]');
                    if (dbUserField) dbUserField.value = envValues.DB_USER;
                }
                
                // Note: We don't pre-fill DB_PASS for security reasons
                // Users will need to re-enter their database password
                
                if (envValues.DB_FILE) {
                    const dbFileField = document.querySelector('[name="db_file"]');
                    if (dbFileField) dbFileField.value = envValues.DB_FILE;
                }
                
            } catch (error) {
                console.error('Failed to load existing .env values:', error);
            }
        }
        
        // Show specific step
        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show the requested step
            const targetStep = document.querySelector(`[data-step="${stepNumber}"].step`);
            if (targetStep) {
                targetStep.classList.add('active');
            }
            
            // Update step indicators
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                const stepNum = index + 1;
                
                if (stepNum === stepNumber) {
                    indicator.classList.add('active');
                } else if (stepNum < stepNumber) {
                    indicator.classList.add('completed');
                }
            });
        }

          // Step navigation
          function nextStep(step) {
              // Basic per-step sanity checks can go here
              // When stepping to verification (5), populate the verify UI
              if (step === 5) {
                  const form = document.getElementById('installForm');
                  const formData = new FormData(form);

                  // Optional debug
                  console.log('=== VERIFICATION DATA ===');
                  console.log('Database User:', formData.get('db_user'));
                  console.log('Database Pass:', formData.get('db_pass'));
                  console.log('Admin User:', formData.get('admin_username'));
                  console.log('Admin Pass:', formData.get('admin_password'));
                  console.log('========================');

                  // Populate verify fields
                  const setVerify = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || '' };

                  setVerify('verify-site-name', formData.get('site_name'));
                  setVerify('verify-site-url', formData.get('site_url'));

                  setVerify('verify-db-type', formData.get('db_type'));
                  setVerify('verify-db-host', formData.get('db_host'));
                  setVerify('verify-db-port', formData.get('db_port'));
                  setVerify('verify-db-name', formData.get('db_name'));
                  setVerify('verify-db-user', formData.get('db_user'));
                  setVerify('verify-db-pass', formData.get('db_pass') ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '');

                  // Admin information
                  setVerify('verify-admin-fname', formData.get('admin_first_name'));
                  setVerify('verify-admin-mname', formData.get('admin_middle_name'));
                  setVerify('verify-admin-lname', formData.get('admin_last_name'));
                  setVerify('verify-admin-email', formData.get('admin_email'));
                  setVerify('verify-admin-username', formData.get('admin_username'));
                  setVerify('verify-admin-password', formData.get('admin_password') ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '');

                  // Default user information
                  setVerify('verify-default-username', formData.get('default_username'));
                  setVerify('verify-default-email', formData.get('default_email'));
                  setVerify('verify-default-password', formData.get('default_password') ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '');
              }

              // finally show the requested step
              showStep(step);
          }

        function previousStep(step) {
            console.log('previousStep called with step:', step);
            showStep(step);
        }

        // Database field toggle
        function toggleDatabaseFields() {
            const dbType = document.querySelector('[name="db_type"]').value;
            const sqliteFields = document.getElementById('sqlite-fields');
            const mysqlFields = document.getElementById('mysql-fields');
            
            if (dbType === 'sqlite') {
                sqliteFields.style.display = 'block';
                mysqlFields.style.display = 'none';
            } else {
                sqliteFields.style.display = 'none';
                mysqlFields.style.display = 'block';
            }
        }
        
        // Initialize field visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set MySQL as default and show appropriate fields
            setTimeout(() => {
                toggleDatabaseFields();
            }, 100);
        });

        // System requirements check
        async function checkSystemRequirements() {
            // Simulate requirements check for now to bypass server issues
            setTimeout(() => {
                updateRequirementCheck('php-check', {
                    status: true,
                    message: 'PHP version 8.1+ detected ‚úì'
                });
                
                updateRequirementCheck('database-check', {
                    status: true, 
                    message: 'MySQL/SQLite support available ‚úì'
                });
                
                updateRequirementCheck('writable-check', {
                    status: true,
                    message: 'Directory permissions OK ‚úì'
                });
                
                updateRequirementCheck('extensions-check', {
                    status: true,
                    message: 'Required PHP extensions loaded ‚úì'
                });
                
                // Enable next button but stay on step 1
                const nextBtn = document.getElementById('next-btn-1');
                if (nextBtn) {
                    nextBtn.disabled = false;
                }
            }, 2000);
        }        function updateRequirementCheck(elementId, result) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('.w-6');
            const text = element.querySelector('span');
            
            if (result.status) {
                icon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                text.textContent = result.message;
                element.classList.add('border-green-300', 'bg-green-50');
            } else {
                icon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                text.textContent = result.message;
                element.classList.add('border-red-300', 'bg-red-50');
            }
        }

        // Error display function
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded';
            errorDiv.textContent = message;
            
            // Remove any existing error messages
            const existingErrors = document.querySelectorAll('.bg-red-100');
            existingErrors.forEach(error => error.remove());
            
            // Add error message to current step
            const currentStep = document.querySelector('.step.active');
            if (currentStep) {
                currentStep.insertBefore(errorDiv, currentStep.firstChild);
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Database connection test
        async function testDatabaseConnection() {
            const formData = new FormData(document.getElementById('installForm'));
            const resultDiv = document.getElementById('db-test-result');
            const dbType = formData.get('db_type');

            resultDiv.innerHTML = '<div class="text-blue-600">Testing connection...</div>';

            // For SQLite, just check if path is writable
            if (dbType === 'sqlite') {
                setTimeout(() => {
                    resultDiv.innerHTML = '<div class="text-green-600">‚úì SQLite database path is accessible!</div>';
                }, 1000);
                return;
            }

            // For MySQL, actually test the connection
            const host = formData.get('db_host') || 'localhost';
            const port = formData.get('db_port') || '3306';
            const user = formData.get('db_user') || '';
            const pass = formData.get('db_pass') || '';
            const dbname = formData.get('db_name') || 'ginto_cms';

            if (!host || !user) {
                resultDiv.innerHTML = '<div class="text-red-600">‚úó Please enter host and username</div>';
                return;
            }

            if (!dbname) {
                resultDiv.innerHTML = '<div class="text-red-600">‚úó Please enter database name</div>';
                return;
            }

            try {
                // Test actual connection via backend
                const response = await fetch('/install.php?action=test_database', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `db_type=${dbType}&db_host=${host}&db_port=${port}&db_user=${user}&db_pass=${pass}&db_name=${dbname}`
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const responseText = await response.text();
                console.log('Database test response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Raw response:', responseText);
                    throw new Error(`Server returned invalid response: ${responseText.substring(0, 100)}...`);
                }
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="text-green-600">‚úì ${result.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="text-red-600">‚úó ${result.message}</div>`;
                }
            } catch (error) {
                console.error('Database connection test error:', error);
                resultDiv.innerHTML = `<div class="text-red-600">‚úó Connection test failed: ${error.message}</div>`;
            }
        }        // Installation process
        async function startInstallation() {
            // Always show the installation step panel when starting install
            showStep(6);
            const form = document.getElementById('installForm');
            const formData = new FormData(form);
            
            // Add default values for any missing fields
            if (!formData.get('site_name')) formData.set('site_name', 'Ginto CMS');
            if (!formData.get('site_url')) formData.set('site_url', window.location.origin);
            if (!formData.get('db_type')) formData.set('db_type', 'mysql');
            if (!formData.get('db_host')) formData.set('db_host', 'localhost');
            if (!formData.get('db_port')) formData.set('db_port', '3306');
            if (!formData.get('db_name')) formData.set('db_name', 'ginto');
            if (!formData.get('db_file')) formData.set('db_file', 'database.sqlite');
            if (!formData.get('admin_email')) formData.set('admin_email', 'admin@example.com');
            if (!formData.get('admin_username')) formData.set('admin_username', 'admin');
            
            // design: password requirement is informational only; server-side will enforce whatever rules are necessary

            console.log('Form data collected:', Object.fromEntries(formData.entries()));

            const backBtn = document.getElementById('back-btn-6');
            const installBtn = document.getElementById('install-btn');
            if (backBtn) backBtn.style.display = 'none';
            if (installBtn) installBtn.style.display = 'none';

            const steps = [
                { id: 'create-config', name: 'Creating configuration files' },
                { id: 'setup-database', name: 'Setting up database' },
                { id: 'run-migrations', name: 'Running database migrations' },
                { id: 'create-admin', name: 'Creating admin account' },
                { id: 'import-demo', name: 'Importing demo content' },
                { id: 'finalize', name: 'Finalizing installation' }
            ];

            try {
                for (const step of steps) {
                    console.log(`Starting step: ${step.id}`);
                    await executeInstallationStep(step, formData);
                    markStepComplete(step.id);
                    console.log(`Completed step: ${step.id}`);
                }

                // Show completion message
                document.getElementById('installation-progress').style.display = 'none';
                document.getElementById('installation-complete').style.display = 'block';

            } catch (error) {
                console.error('Installation failed:', error);
                
                // Show detailed error information with proper styling
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mt-6 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg';
                errorDiv.innerHTML = `
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-red-800 dark:text-red-200">Installation Failed</h3>
                    </div>
                    <p class="text-red-700 dark:text-red-300 mb-4">${error.message}</p>
                    <div class="flex space-x-4">
                        <button type="button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="showStep(4)">
                            Go Back to Admin Account
                        </button>
                        <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600" onclick="location.reload()">
                            Restart Installation
                        </button>
                    </div>
                `;
                
                // Insert error message in the installation step (step 6)
                const installationDiv = document.querySelector('.step[data-step="6"] .p-8');
                if (installationDiv) {
                    installationDiv.appendChild(errorDiv);
                }
                
                // Re-enable navigation buttons
                const backBtn = document.getElementById('back-btn-6');
                const installBtn = document.getElementById('install-btn');
                if (backBtn) backBtn.style.display = 'inline-block';
                if (installBtn) {
                    installBtn.style.display = 'inline-block';
                    installBtn.textContent = 'Retry Installation';
                }
            }
        }

        async function executeInstallationStep(step, formData) {
            console.log(`Executing step: ${step.name}`);
            
            const requestData = {
                step: step.id,
                data: Object.fromEntries(formData.entries())
            };
            
            console.log('Request data:', requestData);
            
            try {
                // Make API call to install.php with the step and form data
                console.log('Fetching: /install.php');
                const response = await fetch('/install.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error text:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\nResponse: ${errorText}`);
                }
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(`Invalid JSON response: ${responseText}`);
                }
                
                if (result.success) {
                    console.log(`Step ${step.id} completed successfully:`, result.message);
                    return { success: true, message: result.message };
                } else {
                    throw new Error(result.message || `Step ${step.id} failed`);
                }
                
            } catch (error) {
                console.error(`Step ${step.id} failed:`, error);
                throw error;
            }
        }

        function markStepComplete(stepId) {
            const element = document.getElementById(stepId);
            const icon = element.querySelector('.w-6');
            const text = element.querySelector('span');
            
            icon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
            text.textContent = text.textContent.replace('...', ' ‚úì');
            element.classList.add('border-green-300', 'bg-green-50');
        }
    </script>
</body>
</html>